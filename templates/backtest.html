<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtesting - OI Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --danger-gradient: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            --dark-bg: #0f0f23;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--dark-bg);
            background-image: 
                radial-gradient(at 40% 20%, hsla(240, 80%, 30%, 0.4) 0px, transparent 50%),
                radial-gradient(at 80% 0%, hsla(280, 80%, 30%, 0.4) 0px, transparent 50%);
            min-height: 100vh;
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: var(--text-primary);
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
            display: block;
        }

        .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 6px;
            width: 100%;
        }

        .form-control:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #667eea;
            outline: none;
            color: var(--text-primary);
        }

        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: scale(1.05);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.08); /* Brighter background for better contrast */
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary); /* Default white color for better visibility */
        }

        .metric-value.positive {
            color: #38ef7d;
        }

        .metric-value.negative {
            color: #f45c43;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .trades-table th {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            text-align: left;
            color: var(--text-secondary);
            font-weight: 600;
            border-bottom: 1px solid var(--card-border);
        }

        .trades-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-primary); /* Ensure text is visible */
        }

        .trades-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        .trades-table td.positive {
            color: #38ef7d !important;
            font-weight: 600;
        }
        
        .trades-table td.negative {
            color: #f45c43 !important;
            font-weight: 600;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(56, 239, 125, 0.2);
            color: #38ef7d;
        }

        .badge-danger {
            background: rgba(244, 92, 67, 0.2);
            color: #f45c43;
        }

        .badge-info {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>

        <div class="header">
            <h1><i class="bi bi-graph-up-arrow"></i> Backtesting</h1>
            <p style="color: var(--text-secondary);">Test your trading strategy on historical data</p>
        </div>

        <!-- Backtest Form -->
        <div class="card">
            <div class="card-title">
                <i class="bi bi-sliders"></i> Backtest Parameters
            </div>
            <form id="backtestForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Exchange</label>
                        <select class="form-control" id="exchange" name="exchange" required>
                            <option value="NSE">NSE (NIFTY)</option>
                            <option value="BSE">BSE (SENSEX)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Initial Capital (₹)</label>
                        <input type="number" class="form-control" id="initial_capital" name="initial_capital" value="100000" min="1000" step="1000" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Entry Threshold (%)</label>
                        <input type="number" class="form-control" id="entry_threshold" name="entry_threshold" value="0.02" min="0.001" step="0.001" required>
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">Minimum predicted change to enter trade</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Exit Threshold (%)</label>
                        <input type="number" class="form-control" id="exit_threshold" name="exit_threshold" value="0.05" min="0.001" step="0.001" required>
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">Profit target to exit trade</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Stop Loss (%)</label>
                        <input type="number" class="form-control" id="stop_loss_pct" name="stop_loss_pct" value="0.03" min="0.001" step="0.001" required>
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">Maximum loss before exit</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Holding Periods</label>
                        <input type="number" class="form-control" id="max_holding_periods" name="max_holding_periods" value="30" min="1" step="1" required>
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">Maximum periods to hold position</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Lookback Days</label>
                        <input type="number" class="form-control" id="lookback_days" name="lookback_days" value="30" min="1" max="90" step="1" required>
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">Days of historical data to use</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Position Size (%)</label>
                        <input type="number" class="form-control" id="position_size_pct" name="position_size_pct" value="0.1" min="0.01" max="1" step="0.01" required>
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">Percentage of capital per trade</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Commission Rate</label>
                        <input type="number" class="form-control" id="commission_rate" name="commission_rate" value="0.0003" min="0" step="0.0001" required>
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">Commission as decimal (0.0003 = 0.03%)</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Slippage</label>
                        <input type="number" class="form-control" id="slippage" name="slippage" value="0.0001" min="0" step="0.0001" required>
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">Slippage as decimal (0.0001 = 0.01%)</small>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="runBacktestBtn">
                    <i class="bi bi-play-fill"></i> Run Backtest
                </button>
            </form>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display: none;">
            <!-- Metrics -->
            <div class="card">
                <div class="card-title">
                    <i class="bi bi-bar-chart-fill"></i> Performance Metrics
                </div>
                <div class="results-grid" id="metricsGrid"></div>
            </div>

            <!-- Equity Curve Chart -->
            <div class="card">
                <div class="card-title">
                    <i class="bi bi-graph-up"></i> Equity Curve
                </div>
                <div class="chart-container">
                    <canvas id="equityChart"></canvas>
                </div>
            </div>

            <!-- Trades Table -->
            <div class="card">
                <div class="card-title">
                    <i class="bi bi-table"></i> Trade History
                </div>
                <div style="overflow-x: auto;">
                    <table class="trades-table" id="tradesTable">
                        <thead>
                            <tr>
                                <th>Entry Time</th>
                                <th>Exit Time</th>
                                <th>Type</th>
                                <th>Entry Price</th>
                                <th>Exit Price</th>
                                <th>Quantity</th>
                                <th>P&L</th>
                                <th>P&L %</th>
                                <th>Exit Reason</th>
                            </tr>
                        </thead>
                        <tbody id="tradesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Running backtest... This may take a moment.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let equityChart = null;

        document.getElementById('backtestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = isNaN(value) ? value : parseFloat(value);
            });

            // Show loading
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('runBacktestBtn').disabled = true;

            try {
                const response = await fetch('/api/backtest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Backtest failed');
                }

                displayResults(result);
            } catch (error) {
                alert('Error: ' + error.message);
                console.error(error);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('runBacktestBtn').disabled = false;
            }
        });

        function displayResults(result) {
            const metrics = result.results;
            const trades = result.trades;
            const equityCurve = result.equity_curve;

            // Display metrics
            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-label">Total Return</div>
                    <div class="metric-value ${metrics.total_return_pct >= 0 ? 'positive' : 'negative'}">
                        ${metrics.total_return_pct >= 0 ? '+' : ''}${metrics.total_return_pct.toFixed(2)}%
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total P&L</div>
                    <div class="metric-value ${metrics.total_pnl >= 0 ? 'positive' : 'negative'}">
                        ₹${metrics.total_pnl.toFixed(2)}
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Final Capital</div>
                    <div class="metric-value">
                        ₹${metrics.final_capital.toFixed(2)}
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Trades</div>
                    <div class="metric-value">${metrics.total_trades}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Win Rate</div>
                    <div class="metric-value ${metrics.win_rate >= 0.5 ? 'positive' : 'negative'}">
                        ${(metrics.win_rate * 100).toFixed(2)}%
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Winning Trades</div>
                    <div class="metric-value positive">${metrics.winning_trades}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Losing Trades</div>
                    <div class="metric-value negative">${metrics.losing_trades}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Avg Win</div>
                    <div class="metric-value positive">₹${metrics.avg_win.toFixed(2)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Avg Loss</div>
                    <div class="metric-value negative">₹${metrics.avg_loss.toFixed(2)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Profit Factor</div>
                    <div class="metric-value ${metrics.profit_factor >= 1 ? 'positive' : 'negative'}">
                        ${metrics.profit_factor.toFixed(2)}
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Max Drawdown</div>
                    <div class="metric-value negative">
                        ${metrics.max_drawdown_pct.toFixed(2)}%
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Sharpe Ratio</div>
                    <div class="metric-value ${metrics.sharpe_ratio >= 1 ? 'positive' : 'negative'}">
                        ${metrics.sharpe_ratio.toFixed(2)}
                    </div>
                </div>
            `;

            // Display equity curve
            if (equityChart) {
                equityChart.destroy();
            }

            const ctx = document.getElementById('equityChart').getContext('2d');
            const labels = equityCurve.map(d => new Date(d.timestamp).toLocaleString());
            const equity = equityCurve.map(d => d.equity);

            equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Equity',
                        data: equity,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#ffffff', /* Brighter white for better visibility */
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.2)', /* Brighter grid lines */
                                lineWidth: 1
                            }
                        },
                        y: {
                            ticks: {
                                color: '#ffffff', /* Brighter white for better visibility */
                                callback: function(value) {
                                    return '₹' + value.toLocaleString();
                                },
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.2)', /* Brighter grid lines */
                                lineWidth: 1
                            }
                        }
                    }
                }
            });

            // Display trades
            const tradesTableBody = document.getElementById('tradesTableBody');
            tradesTableBody.innerHTML = trades.map(trade => `
                <tr>
                    <td>${trade.entry_time ? new Date(trade.entry_time).toLocaleString() : '-'}</td>
                    <td>${trade.exit_time ? new Date(trade.exit_time).toLocaleString() : '-'}</td>
                    <td><span class="badge badge-info">${trade.trade_type}</span></td>
                    <td>₹${trade.entry_price.toFixed(2)}</td>
                    <td>${trade.exit_price ? '₹' + trade.exit_price.toFixed(2) : '-'}</td>
                    <td>${trade.quantity}</td>
                    <td class="${trade.pnl >= 0 ? 'positive' : 'negative'}">
                        ₹${trade.pnl ? trade.pnl.toFixed(2) : '-'}
                    </td>
                    <td class="${trade.pnl_pct >= 0 ? 'positive' : 'negative'}">
                        ${trade.pnl_pct ? (trade.pnl_pct >= 0 ? '+' : '') + trade.pnl_pct.toFixed(2) + '%' : '-'}
                    </td>
                    <td>${trade.exit_reason || '-'}</td>
                </tr>
            `).join('');

            // Show results
            document.getElementById('resultsSection').style.display = 'block';
        }
    </script>
</body>
</html>

